<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeonChat - Fast Connect</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    
    <style>
        /* --- SAME NEON CSS AS BEFORE --- */
        :root { --bg-dark: #050a10; --glass-bg: rgba(20, 30, 45, 0.6); --glass-border: rgba(255, 255, 255, 0.1); --neon-cyan: #00fff2; --neon-pink: #ff00ff; --text-primary: #ffffff; --text-secondary: #a0aab8; }
        * { box-sizing: border-box; }
        body { background-color: var(--bg-dark); background-image: radial-gradient(circle at 20% 30%, rgba(0, 255, 242, 0.15) 0%, transparent 50%), radial-gradient(circle at 80% 70%, rgba(255, 0, 255, 0.15) 0%, transparent 50%); color: var(--text-primary); font-family: 'Roboto', sans-serif; margin: 0; height: 100vh; overflow: hidden; display: flex; flex-direction: column; }
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid var(--glass-border); border-radius: 20px; }
        .btn-neon { background: transparent; border: 2px solid var(--neon-cyan); color: var(--neon-cyan); padding: 15px 40px; font-size: 18px; font-family: 'Orbitron', sans-serif; text-transform: uppercase; letter-spacing: 2px; border-radius: 50px; cursor: pointer; position: relative; overflow: hidden; transition: all 0.3s ease; box-shadow: 0 0 10px rgba(0, 255, 242, 0.3); }
        .btn-neon:hover { background: var(--neon-cyan); color: var(--bg-dark); box-shadow: 0 0 30px var(--neon-cyan); }
        .btn-neon.pink { border-color: var(--neon-pink); color: var(--neon-pink); box-shadow: 0 0 10px rgba(255, 0, 255, 0.3); }
        .btn-neon.pink:hover { background: var(--neon-pink); color: var(--bg-dark); box-shadow: 0 0 30px var(--neon-pink); }
        
        /* HEADER & UI */
        .header { padding: 20px; display: flex; justify-content: space-between; align-items: center; z-index: 10; }
        .logo { font-family: 'Orbitron', sans-serif; font-size: 24px; font-weight: 700; background: linear-gradient(to right, var(--neon-cyan), var(--neon-pink)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .my-profile-chip { display: flex; align-items: center; padding: 8px 15px; border-radius: 30px; cursor: pointer; gap: 10px; }
        .my-avatar-tiny { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid var(--neon-pink); }
        
        /* SCREENS */
        .screen { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; transition: opacity 0.5s ease; }
        #home-screen { text-align: center; padding: 30px; }
        #searching-screen, #video-screen { display: none; }
        .hero-text { font-size: 32px; margin-bottom: 10px; font-family: 'Orbitron', sans-serif; }
        .hero-sub { color: var(--text-secondary); margin-bottom: 50px; }
        
        /* RADAR */
        .radar-container { width: 200px; height: 200px; position: relative; margin-bottom: 40px; }
        .radar-circles { position: absolute; width: 100%; height: 100%; border: 2px solid rgba(0, 255, 242, 0.3); border-radius: 50%; }
        .radar-scanner { position: absolute; width: 100%; height: 100%; background: conic-gradient(from 0deg, transparent 0deg, rgba(0, 255, 242, 0.4) 60deg, transparent 60deg); border-radius: 50%; animation: rotate-radar 3s linear infinite; }
        @keyframes rotate-radar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .searching-text { font-size: 24px; font-family: 'Orbitron', sans-serif; }
        
        /* VIDEO */
        #video-screen { background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #remote-video { position: absolute; top: 0; left: 0; z-index: 1; }
        #local-video { position: absolute; bottom: 100px; right: 20px; width: 100px; height: 140px; background: #333; border-radius: 15px; border: 2px solid var(--neon-cyan); transform: scaleX(-1); z-index: 2; }
        .partner-info-overlay { position: absolute; top: 20px; left: 20px; z-index: 3; display: flex; align-items: center; gap: 15px; padding: 15px; }
        .partner-avatar-large { width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--neon-pink); }
        .video-controls { position: absolute; bottom: 30px; width: 100%; z-index: 3; display: flex; justify-content: center; gap: 20px; }
        .control-btn { width: 70px; height: 70px; border-radius: 50%; border: none; display: flex; justify-content: center; align-items: center; font-size: 30px; cursor: pointer; color: white; backdrop-filter: blur(10px); }
        .btn-stop { background: rgba(244, 67, 54, 0.8); border: 2px solid #ff3333; }
        .btn-next { background: rgba(0, 255, 242, 0.8); border: 2px solid var(--neon-cyan); color: var(--bg-dark); }
        
        /* MODAL */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: none; justify-content: center; align-items: center; backdrop-filter: blur(10px); }
        .modal-box { width: 90%; max-width: 400px; padding: 30px; text-align: center; display: flex; flex-direction: column; align-items: center; }
        .avatar-preview { width: 100px; height: 100px; border-radius: 50%; margin-bottom: 20px; border: 3px solid var(--neon-cyan); object-fit: cover; }
        input.neon-input { width: 100%; padding: 15px; margin: 10px 0; background: rgba(255,255,255,0.1); border: 1px solid var(--neon-cyan); color: white; border-radius: 10px; text-align: center; font-size: 16px; outline: none; }
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">NEON<span style="color:var(--neon-pink)">CHAT</span></div>
        <div class="my-profile-chip glass-panel" onclick="openProfileModal()">
            <img src="" id="disp-my-avatar" class="my-avatar-tiny" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
            <div id="disp-my-name" style="font-weight: 500;">Set Profile</div>
        </div>
    </div>

    <div id="home-screen" class="screen">
        <h1 class="hero-text">Meet Strangers</h1>
        <p class="hero-sub">Tap below to connect instantly.</p>
        <button class="btn-neon" onclick="startSearching()">START CHAT</button>
    </div>

    <div id="searching-screen" class="screen">
        <div class="radar-container"><div class="radar-circles"></div><div class="radar-scanner"></div></div>
        <div class="searching-text" id="search-status">Scanning...</div>
        <p style="color: var(--text-secondary); margin-top: 20px;">Finding active users...</p>
        <button class="btn-neon pink" style="margin-top: 40px; padding: 10px 30px; font-size: 14px;" onclick="stopSearching()">CANCEL</button>
    </div>

    <div id="video-screen" class="screen">
        <div class="partner-info-overlay glass-panel">
            <img src="" id="partner-avatar" class="partner-avatar-large" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
            <div>
                <div id="partner-name" style="font-weight: bold; font-size: 18px; font-family: 'Orbitron', sans-serif;">Unknown</div>
                <div style="font-size: 12px; color: var(--neon-cyan);">Connected</div>
            </div>
        </div>
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div class="video-controls">
            <button class="control-btn btn-stop" onclick="stopCurrentCall()"><i class="material-icons">stop</i></button>
            <button class="control-btn btn-next" onclick="nextStranger()">Next â†’</button>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay">
        <div class="modal-box glass-panel">
            <h3 style="font-family: 'Orbitron', sans-serif;">Setup Identity</h3>
            <img id="preview-avatar" class="avatar-preview" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
            <label for="file-upload" class="btn-neon" style="padding: 8px 20px; font-size: 12px; margin-bottom: 20px;">Choose Photo</label>
            <input type="file" id="file-upload" accept="image/*" style="display:none" onchange="handleImageUpload(this)">
            <input type="text" id="input-name" class="neon-input" placeholder="Enter Name">
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn-neon pink" onclick="closeProfileModal()">Close</button>
                <button class="btn-neon" onclick="saveProfile()">Save</button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION: SMALLER POOL FOR FAST CONNECT ---
        // Range: 10 to 100 (Only 90 numbers) -> High chance of match
        const MIN_ID = 10;
        const MAX_ID = 100;
        
        const DEFAULT_AVATAR = 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
        let tempAvatarData = DEFAULT_AVATAR;
        
        // Generate random ID in small range
        const myID = Math.floor(MIN_ID + Math.random() * (MAX_ID - MIN_ID)).toString();
        
        let myProfile = JSON.parse(localStorage.getItem('neon_profile')) || {
            name: 'User ' + myID,
            avatar: DEFAULT_AVATAR
        };

        let peer = null;
        let currentCall = null;
        let localStream = null;
        let isSearching = false;
        let searchInterval = null;

        // --- 2. INIT ---
        initUI();
        initPeer();

        function initUI() {
            document.getElementById('disp-my-name').innerText = myProfile.name;
            document.getElementById('disp-my-avatar').src = myProfile.avatar;
            document.getElementById('preview-avatar').src = myProfile.avatar;
        }

        function initPeer() {
            peer = new Peer(myID, { config: { iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] } });
            
            peer.on('open', (id) => { console.log('My ID: ' + id); });
            peer.on('error', (err) => { 
                // Ignore peer-unavailable errors during search
                if(err.type !== 'peer-unavailable') console.error(err);
            });

            // INCOMING CALL: Accept immediately
            peer.on('call', (call) => {
                if (isSearching || !currentCall) {
                    console.log("Call received!");
                    stopSearchingInterval(); // Stop scanning
                    acceptCall(call);
                } else {
                    call.close(); // Busy
                }
            });
        }

        // --- 3. SEARCH LOGIC (IMPROVED) ---

        function startSearching() {
            if(isSearching) return;
            
            // 1. Get Camera Permission FIRST
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then((stream) => {
                localStream = stream;
                document.getElementById('local-video').srcObject = stream;
                
                // 2. Start UI and Loop
                isSearching = true;
                showScreen('searching-screen');
                startSearchingLoop();
                
            }).catch(err => {
                alert("Please Allow Camera Permission to chat!");
                console.error(err);
            });
        }

        function startSearchingLoop() {
            let count = 0;
            document.getElementById('search-status').innerText = "Connecting...";

            // Loop faster: Every 800ms
            searchInterval = setInterval(() => {
                count++;
                
                // Pick a random target in the small range
                let targetID;
                do {
                    targetID = Math.floor(MIN_ID + Math.random() * (MAX_ID - MIN_ID)).toString();
                } while (targetID === myID);

                console.log(`Trying ID: ${targetID}`);
                
                // Call with Metadata (Name/Photo)
                const call = peer.call(targetID, localStream, {
                    metadata: { name: myProfile.name, avatar: myProfile.avatar }
                });

                // If connection opens, logic moves to 'acceptCall' on receiver side
                
                // Timeout: If not connected in 1.5s, close and try next
                setTimeout(() => {
                    if(call && !call.open && currentCall !== call) {
                        call.close();
                    }
                }, 1500);

            }, 800);
        }

        function stopSearching() {
            isSearching = false;
            stopSearchingInterval();
            showScreen('home-screen');
            if(localStream) {
                localStream.getTracks().forEach(t => t.stop());
                localStream = null;
            }
        }

        function stopSearchingInterval() {
            if(searchInterval) clearInterval(searchInterval);
            searchInterval = null;
        }

        // --- 4. CALL HANDLING ---

        function acceptCall(call) {
            isSearching = false;
            currentCall = call;
            showScreen('video-screen');
            stopSearchingInterval(); // Double safety

            // Get Caller Info from Metadata
            const pName = call.metadata?.name || "Stranger";
            const pAvatar = call.metadata?.avatar || DEFAULT_AVATAR;
            
            document.getElementById('partner-name').innerText = pName;
            document.getElementById('partner-avatar').src = pAvatar;

            // Ensure we have local stream
            if(localStream) {
                call.answer(localStream);
            } else {
                 navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
                    localStream = stream;
                    document.getElementById('local-video').srcObject = stream;
                    call.answer(stream);
                });
            }

            call.on('stream', (remoteStream) => {
                document.getElementById('remote-video').srcObject = remoteStream;
            });
            call.on('close', handleDisconnect);
            call.on('error', handleDisconnect);
        }

        function stopCurrentCall() {
            if(currentCall) currentCall.close();
            handleDisconnect();
        }

        function nextStranger() {
            stopCurrentCall();
            setTimeout(startSearching, 500); // Wait a bit then restart
        }

        function handleDisconnect() {
            currentCall = null;
            if(document.getElementById('video-screen').style.display === 'flex') {
                stopSearching(); // Go back home
            }
        }

        // --- UI UTILS ---
        function showScreen(id) {
            ['home-screen', 'searching-screen', 'video-screen'].forEach(s => 
                document.getElementById(s).style.display = (s === id) ? 'flex' : 'none'
            );
        }
        function openProfileModal() { document.getElementById('profile-modal').style.display = 'flex'; }
        function closeProfileModal() { document.getElementById('profile-modal').style.display = 'none'; }
        function handleImageUpload(input) { if(input.files[0]) { const reader = new FileReader(); reader.onload = (e) => { tempAvatarData = e.target.result; document.getElementById('preview-avatar').src = tempAvatarData; }; reader.readAsDataURL(input.files[0]); } }
        function saveProfile() { myProfile.name = document.getElementById('input-name').value || myProfile.name; myProfile.avatar = tempAvatarData; localStorage.setItem('neon_profile', JSON.stringify(myProfile)); initUI(); closeProfileModal(); }
    </script>
</body>
</html>
