<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>NeonChat - Random Video</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Roboto:wght@300;400;500&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --bg-dark: #050a10;
            --glass-bg: rgba(20, 30, 45, 0.6);
            --glass-border: rgba(255, 255, 255, 0.1);
            --neon-cyan: #00fff2;
            --neon-pink: #ff00ff;
            --text-primary: #ffffff;
            --text-secondary: #a0aab8;
        }

        * { box-sizing: border-box; }

        body {
            background-color: var(--bg-dark);
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(0, 255, 242, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(255, 0, 255, 0.15) 0%, transparent 50%);
            color: var(--text-primary);
            font-family: 'Roboto', sans-serif;
            margin: 0; height: 100vh; overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- ANIMATIONS --- */
        @keyframes pulse-neon {
            0% { box-shadow: 0 0 10px var(--neon-cyan), 0 0 20px var(--neon-cyan); }
            50% { box-shadow: 0 0 25px var(--neon-cyan), 0 0 40px var(--neon-cyan); }
            100% { box-shadow: 0 0 10px var(--neon-cyan), 0 0 20px var(--neon-cyan); }
        }
        @keyframes scan {
            0% { transform: translateY(-100%); }
            100% { transform: translateY(100vh); }
        }
        @keyframes rotate-radar {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* --- COMMON UI --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
        }

        .btn-neon {
            background: transparent;
            border: 2px solid var(--neon-cyan);
            color: var(--neon-cyan);
            padding: 15px 40px;
            font-size: 18px;
            font-family: 'Orbitron', sans-serif;
            text-transform: uppercase;
            letter-spacing: 2px;
            border-radius: 50px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 242, 0.3);
        }
        .btn-neon:hover {
            background: var(--neon-cyan);
            color: var(--bg-dark);
            box-shadow: 0 0 30px var(--neon-cyan);
        }
        .btn-neon.pink {
            border-color: var(--neon-pink); color: var(--neon-pink);
            box-shadow: 0 0 10px rgba(255, 0, 255, 0.3);
        }
        .btn-neon.pink:hover {
            background: var(--neon-pink); color: var(--bg-dark);
            box-shadow: 0 0 30px var(--neon-pink);
        }
        .btn-neon:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* --- HEADER --- */
        .header {
            padding: 20px; display: flex; justify-content: space-between; align-items: center;
            z-index: 10;
        }
        .logo { font-family: 'Orbitron', sans-serif; font-size: 24px; font-weight: 700; background: linear-gradient(to right, var(--neon-cyan), var(--neon-pink)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        .my-profile-chip {
            display: flex; align-items: center; padding: 8px 15px;
            border-radius: 30px; cursor: pointer; gap: 10px;
        }
        .my-avatar-tiny { width: 35px; height: 35px; border-radius: 50%; object-fit: cover; border: 2px solid var(--neon-pink); }

        /* --- SCREENS --- */
        .screen {
            flex: 1; display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            position: relative; transition: opacity 0.5s ease;
        }
        #home-screen { text-align: center; padding: 30px; }
        #searching-screen, #video-screen { display: none; }

        /* --- HOME SCREEN --- */
        .hero-text { font-size: 32px; margin-bottom: 10px; font-family: 'Orbitron', sans-serif; }
        .hero-sub { color: var(--text-secondary); margin-bottom: 50px; }
        
        .warning-box {
            background: rgba(255, 193, 7, 0.2);
            border: 1px solid rgba(255, 193, 7, 0.5);
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            text-align: center;
            color: #fff;
        }
        
        /* --- SEARCHING SCREEN --- */
        .radar-container {
            width: 200px; height: 200px; position: relative;
            margin-bottom: 40px;
        }
        .radar-circles {
            position: absolute; width: 100%; height: 100%;
            border: 2px solid rgba(0, 255, 242, 0.3); border-radius: 50%;
        }
        .radar-circles::before {
            content: ''; position: absolute; top: 50%; left: 50%;
            width: 60%; height: 60%; transform: translate(-50%, -50%);
            border: 2px solid rgba(0, 255, 242, 0.5); border-radius: 50%;
        }
        .radar-scanner {
            position: absolute; width: 100%; height: 100%;
            background: conic-gradient(from 0deg, transparent 0deg, rgba(0, 255, 242, 0.4) 60deg, transparent 60deg);
            border-radius: 50%; animation: rotate-radar 3s linear infinite;
        }
        .searching-text { font-size: 24px; font-family: 'Orbitron', sans-serif; animation: pulse-neon 2s infinite alternate; }

        /* --- VIDEO SCREEN --- */
        #video-screen { background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #remote-video { position: absolute; top: 0; left: 0; z-index: 1; }
        #local-video { 
            position: absolute; bottom: 100px; right: 20px; width: 100px; height: 140px; 
            background: #333; border-radius: 15px; border: 2px solid var(--neon-cyan); 
            transform: scaleX(-1); z-index: 2; box-shadow: 0 0 20px rgba(0, 255, 242, 0.3);
        }
        
        .partner-info-overlay {
            position: absolute; top: 20px; left: 20px; z-index: 3;
            display: flex; align-items: center; gap: 15px; padding: 15px;
        }
        .partner-avatar-large { width: 60px; height: 60px; border-radius: 50%; border: 3px solid var(--neon-pink); }

        .video-controls {
            position: absolute; bottom: 30px; width: 100%; z-index: 3;
            display: flex; justify-content: center; gap: 20px;
        }
        .control-btn {
            width: 70px; height: 70px; border-radius: 50%; border: none;
            display: flex; justify-content: center; align-items: center;
            font-size: 30px; cursor: pointer; color: white;
            backdrop-filter: blur(10px); transition: all 0.3s;
        }
        .btn-stop { background: rgba(244, 67, 54, 0.8); border: 2px solid #ff3333; }
        .btn-next { background: rgba(0, 255, 242, 0.8); border: 2px solid var(--neon-cyan); color: var(--bg-dark); }
        .control-btn:hover { transform: scale(1.1); }

        /* --- PROFILE MODAL --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100; display: none; 
            justify-content: center; align-items: center; backdrop-filter: blur(10px);
        }
        .modal-box { 
            width: 90%; max-width: 400px; padding: 30px; text-align: center;
            display: flex; flex-direction: column; align-items: center;
        }
        .avatar-preview { width: 100px; height: 100px; border-radius: 50%; margin-bottom: 20px; border: 3px solid var(--neon-cyan); object-fit: cover; }
        input.neon-input {
            width: 100%; padding: 15px; margin: 10px 0;
            background: rgba(255,255,255,0.1); border: 1px solid var(--neon-cyan);
            color: white; border-radius: 10px; text-align: center; font-size: 16px;
            outline: none; transition: all 0.3s;
        }
        input.neon-input:focus { box-shadow: 0 0 15px var(--neon-cyan); }

        /* Permission Status Indicator */
        .permission-status {
            position: fixed; top: 10px; right: 10px; z-index: 1000;
            padding: 8px 12px; border-radius: 20px; font-size: 12px;
            font-family: 'Orbitron', sans-serif;
        }
        .status-granted { background: rgba(76, 175, 80, 0.9); color: white; }
        .status-denied { background: rgba(244, 67, 54, 0.9); color: white; }
        .status-pending { background: rgba(255, 193, 7, 0.9); color: #333; }
    </style>
</head>
<body>

    <div class="permission-status" id="permission-status" style="display: none;"></div>

    <div class="header">
        <div class="logo">NEON<span style="color:var(--neon-pink)">CHAT</span></div>
        <div class="my-profile-chip glass-panel" onclick="openProfileModal()">
            <img src="" id="disp-my-avatar" class="my-avatar-tiny" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
            <div id="disp-my-name" style="font-weight: 500;">Set Profile</div>
        </div>
    </div>

    <div id="home-screen" class="screen">
        <h1 class="hero-text">Meet Strangers.<br>Randomly.</h1>
        <p class="hero-sub">Click below to connect with someone unknown.</p>
        
        <div id="secure-context-warning" class="warning-box" style="display: none;">
            <strong>ðŸš« Camera/Mic à¤•à¤¾à¤® à¤¨à¤¹à¥€à¤‚ à¤•à¤°à¥‡à¤—à¤¾!</strong><br>
            <small>Local server à¤šà¤¾à¤²à¥‚ à¤•à¤°à¥‡à¤‚: <code>python -m http.server 8000</code><br>à¤«à¤¿à¤° <code>http://localhost:8000</code> à¤–à¥‹à¤²à¥‡à¤‚à¥¤
        </div>
        
        <button class="btn-neon" id="start-btn" onclick="startSearching()">START CHAT</button>
        <div style="margin-top: 20px; font-size: 14px; color: var(--text-secondary);">
            <div>Your ID: <strong id="my-id-display"></strong></div>
        </div>
    </div>

    <div id="searching-screen" class="screen">
        <div class="radar-container">
            <div class="radar-circles"></div>
            <div class="radar-scanner"></div>
        </div>
        <div class="searching-text" id="search-status">Checking Camera & Mic...</div>
        <p style="color: var(--text-secondary); margin-top: 20px;">This might take a moment.</p>
        <button class="btn-neon pink" style="margin-top: 40px; padding: 10px 30px; font-size: 14px;" onclick="stopSearching()">CANCEL</button>
    </div>

    <div id="video-screen" class="screen">
        <div class="partner-info-overlay glass-panel">
            <img src="" id="partner-avatar" class="partner-avatar-large" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
            <div>
                <div id="partner-name" style="font-weight: bold; font-size: 18px; font-family: 'Orbitron', sans-serif;">Unknown</div>
                <div style="font-size: 12px; color: var(--neon-cyan);">Connected</div>
            </div>
        </div>

        <video id="remote-video" autoplay playsinline muted></video>
        <video id="local-video" autoplay muted playsinline></video>
        
        <div class="video-controls">
            <button class="control-btn btn-stop" onclick="stopCurrentCall()"><i class="material-icons">stop</i></button>
            <button class="control-btn btn-next" onclick="nextStranger()">Iske Aage â†’</button>
        </div>
    </div>

    <div id="profile-modal" class="modal-overlay">
        <div class="modal-box glass-panel">
            <h3 style="font-family: 'Orbitron', sans-serif; margin-bottom: 20px;">Setup Identity</h3>
            <img id="preview-avatar" class="avatar-preview" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
            
            <label for="file-upload" class="btn-neon" style="padding: 8px 20px; font-size: 12px; margin-bottom: 20px;">Choose Photo</label>
            <input type="file" id="file-upload" accept="image/*" style="display:none" onchange="handleImageUpload(this)">
            
            <input type="text" id="input-name" class="neon-input" placeholder="Enter Alias / Name">
            
            <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button class="btn-neon pink" style="padding: 10px 30px;" onclick="closeProfileModal()">Close</button>
                <button class="btn-neon" style="padding: 10px 30px;" onclick="saveProfile()">Save</button>
            </div>
        </div>
    </div>

    <script>
    // --- CONFIGURATION & STATE ---
    const DEFAULT_AVATAR = 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
    let tempAvatarData = DEFAULT_AVATAR;
    
    // Generate a random 4-digit ID for self
    const myID = Math.floor(1000 + Math.random() * 9000).toString();
    
    let myProfile = JSON.parse(localStorage.getItem('neon_profile')) || {
        name: 'Stranger ' + myID.substring(0,2),
        avatar: DEFAULT_AVATAR
    };

    let peer = null;
    let currentCall = null;
    let localStream = null;
    let isSearching = false;
    let searchInterval = null;

    // --- INITIALIZATION ---
    initUI();
    checkSecureContext();
    initPeer();

    function initUI() {
        document.getElementById('disp-my-name').innerText = myProfile.name;
        document.getElementById('disp-my-avatar').src = myProfile.avatar;
        document.getElementById('preview-avatar').src = myProfile.avatar;
        document.getElementById('my-id-display').innerText = myID;
    }

    function checkSecureContext() {
        const statusEl = document.getElementById('permission-status');
        const warningEl = document.getElementById('secure-context-warning');
        const startBtn = document.getElementById('start-btn');
        
        if (!window.isSecureContext) {
            statusEl.textContent = 'ðŸš« file:// BLOCKED';
            statusEl.className = 'permission-status status-denied';
            statusEl.style.display = 'block';
            warningEl.style.display = 'block';
            startBtn.disabled = true;
            startBtn.innerHTML = 'ðŸš« LOCAL FILE - USE SERVER';
            console.error('ðŸš« getUserMedia requires secure context (localhost/HTTPS)');
            return false;
        }
        
        statusEl.textContent = 'âœ… Secure Context OK';
        statusEl.className = 'permission-status status-granted';
        statusEl.style.display = 'block';
        return true;
    }

    async function requestMediaPermissions() {
        try {
            // Check permission status first
            if ('permissions' in navigator) {
                const cameraPermission = await navigator.permissions.query({name: 'camera'});
                const micPermission = await navigator.permissions.query({name: 'microphone'});
                
                if (cameraPermission.state === 'denied' || micPermission.state === 'denied') {
                    throw new Error('Permission denied in settings');
                }
            }

            const stream = await navigator.mediaDevices.getUserMedia({
                video: {
                    width: { ideal: 640 },
                    height: { ideal: 480 },
                    facingMode: 'user'
                },
                audio: true
            });

            updatePermissionStatus('âœ… Camera & Mic Granted');
            return stream;
            
        } catch (err) {
            console.error('Media permission error:', err);
            updatePermissionStatus('âŒ Permission Denied');
            
            if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                alert(`ðŸ›‘ CAMERA/MIC PERMISSION REQUIRED!

1ï¸âƒ£ Chrome Settings â†’ Privacy â†’ Site Settings â†’ Camera/Microphone
2ï¸âƒ£ "${location.origin}" à¤•à¥‹ ALLOW à¤•à¤°à¥‡à¤‚
3ï¸âƒ£ Page refresh à¤•à¤°à¥‡à¤‚`);
            } else if (err.name === 'NotFoundError') {
                alert('âŒ No camera/microphone found on device');
            } else if (err.name === 'NotReadableError') {
                alert('âŒ Camera/Microphone in use by another app');
            } else {
                alert(`âŒ Media Error: ${err.name}
Check Console (F12)`);
            }
            
            throw err;
        }
    }

    function updatePermissionStatus(status) {
        const el = document.getElementById('permission-status');
        el.textContent = status;
        el.className = status.includes('âœ…') ? 'permission-status status-granted' : 
                       status.includes('âŒ') ? 'permission-status status-denied' : 
                       'permission-status status-pending';
    }

    function initPeer() {
        peer = new Peer(myID, { 
            config: { 
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' }
                ] 
            } 
        });
        
        peer.on('open', (id) => { 
            console.log('âœ… PeerJS Connected. My ID:', id); 
        });
        
        peer.on('error', (err) => { 
            console.error('PeerJS Error:', err);
            if(isSearching && err.type === 'peer-unavailable') {
                // Expected when dialing random peers
                return;
            }
            if(err.type !== 'peer-unavailable') {
                alert("ðŸŒ Connection Error. Retrying...");
            }
        });

        peer.on('call', (call) => {
            console.log('ðŸ“ž Incoming call from:', call.peer);
            if (isSearching || !currentCall) {
                stopSearchingInterval(); 
                acceptCall(call);
            } else {
                call.close();
            }
        });

        peer.on('connection', (conn) => {
            conn.on('open', () => {
                conn.send({ type: 'profile', name: myProfile.name, avatar: myProfile.avatar });
            });
            conn.on('data', (data) => {
                if(data.type === 'profile') {
                    document.getElementById('partner-name').innerText = data.name;
                    document.getElementById('partner-avatar').src = data.avatar;
                }
            });
        });
    }

    // --- FIXED SEARCHING LOGIC ---
    async function startSearching() {
        if(isSearching) return;
        
        // Show searching screen immediately
        isSearching = true;
        showScreen('searching-screen');
        document.getElementById('search-status').innerText = "ðŸ” Requesting Camera & Mic...";
        
        try {
            // Get media stream FIRST
            localStream = await requestMediaPermissions();
            document.getElementById('local-video').srcObject = localStream;
            
            // Now start peer searching
            document.getElementById('search-status').innerText = "Scanning for strangers...";
            startSearchingLoop();
            
        } catch (err) {
            console.error('Start search failed:', err);
            stopSearching();
        }
    }

    function startSearchingLoop() {
        let attemptCount = 0;
        searchInterval = setInterval(() => {
            attemptCount++;
            document.getElementById('search-status').innerText = `Dialing... (${attemptCount})`;
            
            let randomTarget;
            do {
                randomTarget = Math.floor(1000 + Math.random() * 9000).toString();
            } while (randomTarget === myID);

            console.log(`ðŸ“± Calling ${randomTarget}...`);
            const call = peer.call(randomTarget, localStream);
            
            // Cleanup timeout
            setTimeout(() => {
                if(call && !call.open && currentCall !== call) {
                    call.close();
                }
            }, 2000);

        }, 2000);
    }

    function stopSearching() {
        isSearching = false;
        stopSearchingInterval();
        showScreen('home-screen');
        if(localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
            document.getElementById('local-video').srcObject = null;
        }
    }

    function stopSearchingInterval() {
        if(searchInterval) {
            clearInterval(searchInterval);
            searchInterval = null;
        }
    }

    function acceptCall(call) {
        isSearching = false;
        currentCall = call;
        showScreen('video-screen');

        document.getElementById('partner-name').innerText = "Connecting...";
        document.getElementById('partner-avatar').src = DEFAULT_AVATAR;
        
        // Send profile
        const conn = peer.connect(call.peer);
        conn.on('open', () => {
            conn.send({ type: 'profile', name: myProfile.name, avatar: myProfile.avatar });
        });

        // Answer call
        if(localStream) {
            call.answer(localStream);
        } else {
            // Emergency fallback
            navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                .then(stream => {
                    localStream = stream;
                    document.getElementById('local-video').srcObject = stream;
                    call.answer(stream);
                })
                .catch(err => console.error('Fallback media failed:', err));
        }
        
        call.on('stream', (remoteStream) => { 
            document.getElementById('remote-video').srcObject = remoteStream; 
        });
        
        call.on('close', handleCallDisconnect);
        call.on('error', handleCallDisconnect);
    }

    function stopCurrentCall() {
        if(currentCall) {
            currentCall.close();
        }
        handleCallDisconnect();
    }

    function nextStranger() {
        stopCurrentCall();
        setTimeout(startSearching, 800);
    }

    function handleCallDisconnect() {
        if(currentCall) {
            currentCall.close();
            currentCall = null;
        }
        if(!isSearching) {
            showScreen('home-screen');
        }
        console.log('ðŸ“ž Call ended');
    }

    // --- UI HELPERS ---
    function showScreen(screenId) {
        ['home-screen', 'searching-screen', 'video-screen'].forEach(id => {
            const el = document.getElementById(id);
            el.style.display = (id === screenId) ? 'flex' : 'none';
        });
    }

    // --- PROFILE HANDLING ---
    function openProfileModal() { 
        document.getElementById('input-name').value = myProfile.name; 
        document.getElementById('preview-avatar').src = myProfile.avatar; 
        document.getElementById('profile-modal').style.display = 'flex'; 
    }
    
    function closeProfileModal() { 
        document.getElementById('profile-modal').style.display = 'none'; 
    }
    
    function handleImageUpload(input) { 
        if (input.files && input.files[0]) { 
            const reader = new FileReader(); 
            reader.onload = function(e) { 
                const img = new Image(); 
                img.src = e.target.result; 
                img.onload = function() { 
                    const canvas = document.createElement('canvas'); 
                    const ctx = canvas.getContext('2d'); 
                    const MAX_SIZE = 150; 
                    let width = img.width; 
                    let height = img.height; 
                    if (width > height) { 
                        if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; } 
                    } else { 
                        if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; } 
                    } 
                    canvas.width = width; 
                    canvas.height = height; 
                    ctx.drawImage(img, 0, 0, width, height); 
                    tempAvatarData = canvas.toDataURL('image/jpeg', 0.7); 
                    document.getElementById('preview-avatar').src = tempAvatarData; 
                }; 
            }; 
            reader.readAsDataURL(input.files[0]); 
        } 
    }
    
    function saveProfile() { 
        const newName = document.getElementById('input-name').value.trim(); 
        if(newName) { 
            myProfile.name = newName; 
            myProfile.avatar = tempAvatarData; 
            localStorage.setItem('neon_profile', JSON.stringify(myProfile)); 
            initUI(); 
            closeProfileModal(); 
        } else {
            alert('Name required!');
        }
    }

    // Page visibility handling
    document.addEventListener('visibilitychange', () => {
        if (document.hidden && currentCall) {
            stopCurrentCall();
        }
    });
    </script>
</body>
</html>
